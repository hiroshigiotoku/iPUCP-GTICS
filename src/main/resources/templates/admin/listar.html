<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}"/>
    <link rel="stylesheet" th:href="@{/css/style2.css}" />


    <!-- Necessary script for to launch Bootstrap modal on page load -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
            crossorigin="anonymous"></script>

    <!-- DATATABLES -->
    <!--  <link rel="stylesheet" href="https://cdn.datatables.net/1.10.20/css/jquery.dataTables.min.css"> -->
    <!-- BOOTSTRAP -->


    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.20/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.css">


    <title>Listar Usuarios</title>
    <style>
        @media (max-width: 400px) {
            .hidden-mobile {
                display: none;
            }
        }
    </style>
</head>
<body>
<main>

    <div th:replace="admin/fragment.html :: navbar"></div>

    <br>

    <div class="container px-4 py-5">
        <h1 class="pb-2 border-bottom" style="text-align: center">Información de los usuarios</h1>
        <div class="container">
            <div class="row">

                <div class="col-sm" style="display: flex; justify-content: space-around">
                    <form class="container-fluid" method="post" th:action="@{/admin/BuscarCategoria}">
                        <div class="row">
                            <div class="col-sm">
                                <select class="form-select col-" aria-label="Default select example" name="idcat" id="idcat">
                                    <option value="0">Todos</option>
                                    <option th:each="cargo : ${listaCargos}"
                                            th:text="${cargo.nombreCargo}"
                                            th:value="${cargo.id}"
                                            th:selected="${cargo.id} eq ${id}">
                                    </option>
                                </select>
                            </div>

                            <div class="col-sm">
                                <button type="submit" class="btn btn-success">Filtrar Categoría</button>
                            </div>
                        </div>
                    </form>
                    <div class="col-sm-6 mb-4" style="display: flex; justify-content: flex-end">
                        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#Modal2">Agregar nuevo usuario</button>
                    </div>

                </div>
            </div>
        </div>

        <div th:if="${msg != null}" th:text="${msg}" class="alert alert-success" role="alert"></div>

        <div >
            <table class="table table-striped display nowrap" id="tablax" style="overflow-x: auto; overflow-y: auto" width="100%">
                <thead style="color: #0095f6">
                <tr class="table-info">
                    <th style="text-align: center">Usuario</th>
                    <th style="text-align: center">Código</th>
                    <th style="text-align: center">Correo</th>
                    <th style="text-align: center">Celular</th>
                    <th style="text-align: center">DNI</th>
                    <th style="text-align: center">Strikes</th>
                    <th style="text-align: center">Acción</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="usuario : ${listaUsuarios}">
                    <td>
                        <div class="d-flex align-items-center">
                            <img
                                    src="https://mdbootstrap.com/img/new/avatars/8.jpg"
                                    alt=""
                                    style="width: 45px; height: 45px"
                                    class="rounded-circle"
                            />
                            <div class="ms-3">
                                <p th:text="${usuario.nombre} + ' ' + ${usuario.apellido}" class="fw-bold mb-1">Angelo Ramos</p>
                                <p th:text="${usuario.cargo.nombreCargo}" class="text-muted mb-0">Alumno</p>
                            </div>
                        </div>
                    </td>
                    <th th:text="${usuario.id}" style="text-align: center">20192258</th>
                    <th th:text="${usuario.correo}" style="text-align: center">a20192258@pucp.edu.pe</th>
                    <th th:text="${usuario.celular}" style="text-align: center">993606147</th>
                    <th th:text="${usuario.dni}" style="text-align: center">72673679</th>
                    <th th:text="${usuario.strikes}" style="text-align: center">1</th>
                    <div th:switch="${usuario.ban}">
                        <td th:case="0" style="text-align: center"><button type="button" class="btn btn-danger" data-bs-toggle="modal" th:attr="data-bs-target=${'#Modal'+usuario.id}">Suspender</button></td>
                        <td th:case="1" style="text-align: center"><a type="button" class="btn btn-success" th:href="@{'/admin/habilitar?id=' + ${usuario.id}}">Habilitar</a></td>
                    </div>
                </tr>
                </tbody>
            </table>
        </div>

    </div>


    <!-- Modal -->
    <div th:each="usuario : ${listaUsuarios}">
        <div class="modal fade" th:id="${'Modal'+usuario.id}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Suspensión de cuenta</h5>
                        <button th:unless="${#fields.hasErrors('usuario.justificacion')}" type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        <a th:if="${#fields.hasErrors('usuario.justificacion')}" type="button" class="btn-close" th:href="@{'/admin/listar'}" aria-label="Close"></a>
                    </div>
                    <div class="modal-body">
                        <p th:text="${'La cuenta de '+usuario.nombre+' '+usuario.apellido+' será suspendida'}">info</p>

                        <form method="post" th:action="@{'/admin/suspender'}" class="mt-2" th:id="${'form'+usuario.id}">
                            <div class="mb-3">
                                <input th:value="${usuario.id}" name="id" type="hidden"/>

                                <!-- To-do esto es para que no se envie estos valores nulos al recibirlo en admin en suspender -->
                                <input th:value="${usuario.nombre}" name="nombre" type="hidden"/>
                                <input th:value="${usuario.apellido}" name="apellido" type="hidden"/>
                                <input th:value="${usuario.correo}" name="correo" type="hidden"/>
                                <input th:value="${usuario.celular}" name="celular" type="hidden"/>
                                <input th:value="${usuario.dni}" name="dni" type="hidden"/>
                                <input th:value="${usuario.estado}" name="estado" type="hidden"/>
                                <input th:value="${usuario.cargo.id}" name="cargo" type="hidden"/>
                                <input th:value="${usuario.strikes}" name="strikes" type="hidden"/>
                                <input th:value="${usuario.ban}" name="ban" type="hidden"/>
                                <input value="defaultPassword"  name="contra" type="hidden"/>
                                <!-- ################################################################################3 -->

                                <label for="justificacion" class="form-label">Ingrese justificación: </label>
                                <textarea th:field="${usuario.justificacion}" class="form-control" name="justificacion" id="justificacion" rows="4"
                                          th:classappend="${#fields.hasErrors('usuario.justificacion')?'is-invalid':''}"></textarea>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('usuario.justificacion')}"
                                     th:errors="${usuario.justificacion}">
                                    Please choose a username.
                                </div>
                            </div>
                        </form>

                    </div>
                    <div class="modal-footer">
                        <button th:unless="${#fields.hasErrors('usuario.justificacion')}" type="button" class="btn btn-secondary" data-bs-dismiss="modal">Regresar</button>
                        <a th:if="${#fields.hasErrors('usuario.justificacion')}" type="button" class="btn btn-secondary" th:href="@{'/admin/listar'}">Regresar</a>
                        <button type="submit" class="btn btn-danger" th:form="${'form'+usuario.id}">Aceptar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        var myModal = new bootstrap.Modal(document.getElementById('Modal'+[[${id}]]), {})
        myModal.show()
        $('#Modal20196611').modal({backdrop: 'static', keyboard: false})
    </script>


    <!-- Modal 2-->
    <div class="modal fade" id="Modal2" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel2">Seleccionar tipo de usuario</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">

                    <p>Usuario seguridad:</p>
                    <p>Requerirá una contraseña inicial suministrada por el administrador</p>
                    <div class="row">
                        <a class="btn btn-success" th:href="@{'/admin/nuevoSeguridad'}">Agregar usuario seguridad</a>
                    </div>
                    </br>
                    <p>Usuario normal:</p>
                    <p>Para el resto de usuarios, la contraseña será creada directamente por ellos mismos</p>
                    <div class="row">
                        <a class="btn btn-success" th:href="@{'/admin/nuevoNormal'}">Agregar usuario normal</a>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Regresar</button>
                </div>
            </div>
        </div>
    </div>



    <!-- JQUERY -->
    <script src="https://code.jquery.com/jquery-3.4.1.js"
            integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU=" crossorigin="anonymous">
    </script>
    <!-- DATATABLES -->
    <script src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js">
    </script>
    <!-- BOOTSTRAP -->
    <script src="https://cdn.datatables.net/1.10.20/js/dataTables.bootstrap4.min.js">
    </script>
    <script>
        $(document).ready(function () {
            $('#tablax').DataTable({

                scrollX:        true,
                scrollCollapse: true,

                //"bPaginate": false,
                //"bFilter": false,
                //"bInfo": false,
                //"ordering": false,
                language: {
                    processing: "Tratamiento en curso...",
                    search: "Búsqueda&nbsp;:",
                    lengthMenu: "Agrupar de _MENU_ items",
                    info: "Mostrando item _START_ al _END_ de _TOTAL_ en total",
                    infoEmpty: "No existen datos.",
                    infoFiltered: "(filtrado de _MAX_ elementos en total)",
                    infoPostFix: "",
                    loadingRecords: "Cargando...",
                    zeroRecords: "No se encontraron datos con tu busqueda",
                    emptyTable: "No hay datos disponibles en la tabla.",
                    paginate: {
                        first: "Primero",
                        previous: "Anterior",
                        next: "Siguiente",
                        last: "Ultimo"
                    },
                    aria: {
                        sortAscending: ": active para ordenar la columna en orden ascendente",
                        sortDescending: ": active para ordenar la columna en orden descendente"
                    }
                },
                scrollY: 400,
                lengthMenu: [ [10, 25, -1], [10, 25, "All"] ],
            });

            $('.dataTables_filter input[type="search"]').css(
                {'width':'auto','display':'inline-block'}
            );
        });
    </script>

</main>


</body>
</html>